#!/bin/sh
set -eu

if [ "$(uname -s 2>/dev/null)" != "Darwin" ]; then
  echo "This script must run on MacOS." >&2
  exit 1
fi

if [ "$(id -u)" -ne 0 ]; then
  echo "This script must be run as root." >&2
  exit 1
fi

add_dns_if_missing() {
  key="$1"

  if /usr/sbin/scutil <<EOF | grep -q '{'
show ${key}
EOF
  then
    if ! /usr/sbin/scutil <<EOF | grep -Fq "127.0.0.1"
show ${key}
EOF
    then
      /usr/sbin/scutil <<EOF
get ${key}
d.add ServerAddresses * 127.0.0.1
set ${key}
EOF
    fi
  else
    /usr/sbin/scutil <<EOF
d.init
d.add ServerAddresses * 127.0.0.1
set ${key}
EOF
  fi
}

if true; then
  add_dns_if_missing "State:/Network/Global/DNS"
fi

if /usr/sbin/scutil <<'EOF' | grep -q '{'
show State:/Network/Service/com.zscaler.tunnel/DNS
EOF
then
  add_dns_if_missing "State:/Network/Service/com.zscaler.tunnel/DNS"
fi

if /usr/sbin/scutil <<'EOF' | grep -q '{'
show State:/Network/Service/net.pulsesecure.pulse.nc.main/DNS
EOF
then
  add_dns_if_missing "State:/Network/Service/net.pulsesecure.pulse.nc.main/DNS"
fi

if /usr/sbin/networksetup -listallnetworkservices 2>/dev/null \
  | sed '1d;s/^\* //' | grep -Fxq "Wi-Fi"
then
  /usr/sbin/networksetup -setdnsservers "Wi-Fi" 127.0.0.1
fi
